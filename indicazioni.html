<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Display navigation directions</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.2.0/mapbox-gl-directions.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.2.0/mapbox-gl-directions.css" type="text/css">

<div id="map_navigazione"></div>


<script>

    var user_lat;
    var user_lng;

    let id_posizione_aggiornata;
    var destinazione = { 
        latitude: 43.91187814893709,
        longitude: 12.91044693538976
    }

    let options;

    mapboxgl.accessToken = 'pk.eyJ1Ijoibmljb2xvc2luYXRyYSIsImEiOiJjbGs4ZTd0aWowaXNqM2ZybzEzYmplaGF3In0.zJYGpj2MF2Nw8M8XHuXc8Q';
    let map_navigazione = new mapboxgl.Map({
        container: 'map_navigazione', // container ID
        style: 'mapbox://styles/nicolosinatra/clmnjwye901wi01r4h6n9fekx', // style URL
        center: [12.909, 43.909],
        zoom: 14.3
    });

    var MapboxDirections = new MapboxDirections({
        accessToken: mapboxgl.accessToken,
        profile: 'mapbox/walking',
        language: 'it-IT',
        unit: 'metric',
        // profile: 'mapbox/cycling'
        });

    map_navigazione.addControl(
        MapboxDirections, 'top-left'
    );
    
    // definire stile del navigatore
    map_navigazione.on('load',  function() {
        map_navigazione.setLayoutProperty('nomi-economia-corporativa', 'visibility', 'visible');
        map_navigazione.setLayoutProperty('icone-economia-corporativa', 'visibility', 'visible');
        map_navigazione.moveLayer('icone-economia-corporativa');
        map_navigazione.moveLayer('nomi-economia-corporativa');

        map_navigazione.setPaintProperty('directions-route-line-alt', 'line-color', '#fff500');

        map_navigazione.setPaintProperty('directions-route-line-casing', 'line-color', '#000');
        map_navigazione.setPaintProperty('directions-route-line-casing', 'line-width', 6);
        
        map_navigazione.setPaintProperty('directions-route-line', 'line-color', '#fff500');
        map_navigazione.setPaintProperty('directions-route-line', 'line-width', 4);


        map_navigazione.setLayoutProperty('directions-hover-point-casing', 'visibility', 'none');
        map_navigazione.setLayoutProperty('directions-hover-point', 'visibility', 'none');
        map_navigazione.setLayoutProperty('directions-waypoint-point-casing', 'visibility', 'none');
        map_navigazione.setLayoutProperty('directions-waypoint-point', 'visibility', 'none');
        map_navigazione.setLayoutProperty('directions-origin-point', 'visibility', 'none');
        map_navigazione.setLayoutProperty('directions-origin-label', 'visibility', 'none');
        map_navigazione.setLayoutProperty('directions-destination-point', 'visibility', 'none');
        map_navigazione.setLayoutProperty('directions-destination-label', 'visibility', 'none');
    })

    const geolocate = new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        // When active the map will receive updates to the device's location as it changes.
        trackUserLocation: true,
        // Draw an arrow next to the location dot to indicate which direction the device is heading.
        showUserHeading: true
    });
    // Add the control to the map.
    map_navigazione.addControl(geolocate);
    map_navigazione.on('load', () => {
        geolocate.trigger();      
    });
    
    
    function success(pos) {
        const user_crd = pos.coords;
        user_lng = user_crd.longitude;
        user_lat = user_crd.latitude;
    
        map_navigazione.setCenter([user_lng, user_lat]);
        console.log("Your current position is:");
        console.log("Latitude : " + user_lat);
        console.log(`Longitude: ${user_lng}`);
        console.log(`More or less ${user_crd.accuracy} meters.`);
    
        MapboxDirections.setOrigin([user_lng, user_lat]);
        MapboxDirections.setDestination([destinazione.longitude, destinazione.latitude]);

    
        // verificare se sono arrivato a destinazione
        if (destinazione.latitude === user_crd.latitude && destinazione.longitude === user_crd.longitude) {
            console.log("Congratulations, you reached the target");
            navigator.geolocation.clearWatch(id);
        }
    }
    
    function error(err) {
        console.error(`ERROR(${err.code}): ${err.message}`);
    }
    
    options = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0,
    };
    
    id_posizione_aggiornata = navigator.geolocation.watchPosition(success, error, options); 
  

</script>
 
</body>
</html>